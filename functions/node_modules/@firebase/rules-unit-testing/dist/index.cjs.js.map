{"version":3,"file":"index.cjs.js","sources":["../src/impl/url.ts","../src/impl/discovery.ts","../src/impl/test_environment.ts","../src/impl/rules.ts","../src/initialize.ts","../src/util.ts"],"sourcesContent":["/**\n * @license\n * Copyright 2021 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { HostAndPort } from '../public_types';\n\n/**\n * Return a connectable hostname, replacing wildcard 0.0.0.0 or :: with loopback\n * addresses 127.0.0.1 / ::1 correspondingly. See below for why this is needed:\n * https://github.com/firebase/firebase-tools-ui/issues/286\n *\n * This assumes emulators are running on the same device as fallbackHost (e.g.\n * hub), which should hold if both are started from the same CLI command.\n * @private\n */\nexport function fixHostname(host: string, fallbackHost?: string): string {\n  host = host.replace('[', '').replace(']', ''); // Remove IPv6 brackets\n  if (host === '0.0.0.0') {\n    host = fallbackHost || '127.0.0.1';\n  } else if (host === '::') {\n    host = fallbackHost || '::1';\n  }\n  return host;\n}\n\n/**\n * Create a URL with host, port, and path. Handles IPv6 bracketing correctly.\n * @private\n */\nexport function makeUrl(hostAndPort: HostAndPort | string, path: string): URL {\n  if (typeof hostAndPort === 'object') {\n    const { host, port } = hostAndPort;\n    if (host.includes(':')) {\n      hostAndPort = `[${host}]:${port}`;\n    } else {\n      hostAndPort = `${host}:${port}`;\n    }\n  }\n  const url = new URL(`http://${hostAndPort}/`);\n  url.pathname = path;\n  return url;\n}\n","/**\n * @license\n * Copyright 2021 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { EmulatorConfig, HostAndPort } from '../public_types';\nimport nodeFetch from 'node-fetch';\nimport { makeUrl, fixHostname } from './url';\n\n/**\n * Use the Firebase Emulator hub to discover other running emulators.\n *\n * @param hub the host and port where the Emulator Hub is running\n * @private\n */\nexport async function discoverEmulators(\n  hub: HostAndPort,\n  fetch: typeof nodeFetch = nodeFetch\n): Promise<DiscoveredEmulators> {\n  const res = await fetch(makeUrl(hub, '/emulators'));\n  if (!res.ok) {\n    throw new Error(\n      `HTTP Error ${res.status} when attempting to reach Emulator Hub at ${res.url}, are you sure it is running?`\n    );\n  }\n\n  const emulators: DiscoveredEmulators = {};\n\n  const data = await res.json();\n\n  if (data.database) {\n    emulators.database = {\n      host: data.database.host,\n      port: data.database.port\n    };\n  }\n\n  if (data.firestore) {\n    emulators.firestore = {\n      host: data.firestore.host,\n      port: data.firestore.port\n    };\n  }\n\n  if (data.storage) {\n    emulators.storage = {\n      host: data.storage.host,\n      port: data.storage.port\n    };\n  }\n\n  if (data.hub) {\n    emulators.hub = {\n      host: data.hub.host,\n      port: data.hub.port\n    };\n  }\n  return emulators;\n}\n\n/**\n * @private\n */\nexport interface DiscoveredEmulators {\n  database?: HostAndPort;\n  firestore?: HostAndPort;\n  storage?: HostAndPort;\n  hub?: HostAndPort;\n}\n\n/**\n * @private\n */\nexport function getEmulatorHostAndPort(\n  emulator: keyof DiscoveredEmulators,\n  conf?: EmulatorConfig,\n  discovered?: DiscoveredEmulators\n) {\n  if (conf && ('host' in conf || 'port' in conf)) {\n    const { host, port } = conf;\n    if (host || port) {\n      if (!host || !port) {\n        throw new Error(\n          `Invalid configuration ${emulator}.host=${host} and ${emulator}.port=${port}. ` +\n            'If either parameter is supplied, both must be defined.'\n        );\n      }\n      if (discovered && !discovered[emulator]) {\n        console.warn(\n          `Warning: config for the ${emulator} emulator is specified, but the Emulator hub ` +\n            'reports it as not running. This may lead to errors such as connection refused.'\n        );\n      }\n      return {\n        host: fixHostname(conf.host, discovered?.hub?.host),\n        port: conf.port\n      };\n    }\n  }\n  const envVar = EMULATOR_HOST_ENV_VARS[emulator];\n  const fallback = discovered?.[emulator] || emulatorFromEnvVar(envVar);\n  if (fallback) {\n    if (discovered && !discovered[emulator]) {\n      console.warn(\n        `Warning: the environment variable ${envVar} is set, but the Emulator hub reports the ` +\n          `${emulator} emulator as not running. This may lead to errors such as connection refused.`\n      );\n    }\n    return {\n      host: fixHostname(fallback.host, discovered?.hub?.host),\n      port: fallback.port\n    };\n  }\n}\n\n// Visible for testing.\nexport const EMULATOR_HOST_ENV_VARS = {\n  'database': 'FIREBASE_DATABASE_EMULATOR_HOST',\n  'firestore': 'FIRESTORE_EMULATOR_HOST',\n  'hub': 'FIREBASE_EMULATOR_HUB',\n  'storage': 'FIREBASE_STORAGE_EMULATOR_HOST'\n};\n\nfunction emulatorFromEnvVar(envVar: string): HostAndPort | undefined {\n  const hostAndPort = process.env[envVar];\n  if (!hostAndPort) {\n    return undefined;\n  }\n\n  let parsed: URL;\n  try {\n    parsed = new URL(`http://${hostAndPort}`);\n  } catch {\n    throw new Error(\n      `Invalid format in environment variable ${envVar}=${hostAndPort} (expected host:port)`\n    );\n  }\n  let host = parsed.hostname;\n  const port = Number(parsed.port || '80');\n  if (!Number.isInteger(port)) {\n    throw new Error(\n      `Invalid port in environment variable ${envVar}=${hostAndPort}`\n    );\n  }\n  return { host, port };\n}\n","/**\n * @license\n * Copyright 2021 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fetch from 'node-fetch';\nimport firebase from 'firebase/compat/app';\nimport 'firebase/compat/firestore';\nimport 'firebase/compat/database';\nimport 'firebase/compat/storage';\n\nimport {\n  HostAndPort,\n  RulesTestContext,\n  RulesTestEnvironment,\n  TokenOptions\n} from '../public_types';\n\nimport { DiscoveredEmulators } from './discovery';\nimport { makeUrl } from './url';\n\n/**\n * An implementation of {@code RulesTestEnvironment}. This is private to hide the constructor,\n * which should never be directly called by the developer.\n * @private\n */\nexport class RulesTestEnvironmentImpl implements RulesTestEnvironment {\n  private contexts = new Set<RulesTestContextImpl>();\n  private destroyed = false;\n\n  constructor(\n    readonly projectId: string,\n    readonly emulators: DiscoveredEmulators\n  ) {}\n\n  authenticatedContext(\n    user_id: string,\n    tokenOptions?: TokenOptions\n  ): RulesTestContext {\n    this.checkNotDestroyed();\n    return this.createContext({\n      ...tokenOptions,\n      sub: user_id,\n      user_id: user_id\n    });\n  }\n\n  unauthenticatedContext(): RulesTestContext {\n    this.checkNotDestroyed();\n    return this.createContext(/* authToken = */ undefined);\n  }\n\n  async withSecurityRulesDisabled(\n    callback: (context: RulesTestContext) => Promise<void>\n  ): Promise<void> {\n    this.checkNotDestroyed();\n    // The \"owner\" token is recognized by the emulators as a special value that bypasses Security\n    // Rules. This should only ever be used in withSecurityRulesDisabled.\n    // If you're reading this and thinking about doing this in your own app / tests / scripts, think\n    // twice. Instead, just use withSecurityRulesDisabled for unit testing OR connect your Firebase\n    // Admin SDKs to the emulators for integration testing via environment variables.\n    // See: https://firebase.google.com/docs/emulator-suite/connect_firestore#admin_sdks\n    const context = this.createContext('owner');\n    try {\n      await callback(context);\n    } finally {\n      // We eagarly clean up this context to actively prevent misuse outside of the callback, e.g.\n      // storing the context in a variable.\n      context.cleanup();\n      this.contexts.delete(context);\n    }\n  }\n\n  private createContext(\n    authToken: string | firebase.EmulatorMockTokenOptions | undefined\n  ): RulesTestContextImpl {\n    const context = new RulesTestContextImpl(\n      this.projectId,\n      this.emulators,\n      authToken\n    );\n    this.contexts.add(context);\n    return context;\n  }\n\n  clearDatabase(): Promise<void> {\n    this.checkNotDestroyed();\n    return this.withSecurityRulesDisabled(context => {\n      return context.database().ref('/').set(null);\n    });\n  }\n\n  async clearFirestore(): Promise<void> {\n    this.checkNotDestroyed();\n    assertEmulatorRunning(this.emulators, 'firestore');\n\n    const resp = await fetch(\n      makeUrl(\n        this.emulators.firestore,\n        `/emulator/v1/projects/${this.projectId}/databases/(default)/documents`\n      ),\n      {\n        method: 'DELETE'\n      }\n    );\n\n    if (!resp.ok) {\n      throw new Error(await resp.text());\n    }\n  }\n\n  clearStorage(): Promise<void> {\n    this.checkNotDestroyed();\n    return this.withSecurityRulesDisabled(async context => {\n      const { items } = await context.storage().ref().listAll();\n      await Promise.all(\n        items.map(item => {\n          return item.delete();\n        })\n      );\n    });\n  }\n\n  async cleanup(): Promise<void> {\n    this.destroyed = true;\n    this.contexts.forEach(context => {\n      context.envDestroyed = true;\n      context.cleanup();\n    });\n    this.contexts.clear();\n  }\n\n  private checkNotDestroyed() {\n    if (this.destroyed) {\n      throw new Error(\n        'This RulesTestEnvironment has already been cleaned up. ' +\n          '(This may indicate a leak or missing `await` in your test cases. If you do intend to ' +\n          'perform more tests, please call cleanup() later or create another RulesTestEnvironment.)'\n      );\n    }\n  }\n}\n/**\n * An implementation of {@code RulesTestContext}. This is private to hide the constructor,\n * which should never be directly called by the developer.\n * @private\n */\nclass RulesTestContextImpl implements RulesTestContext {\n  private app?: firebase.app.App;\n  private destroyed = false;\n  envDestroyed = false;\n\n  constructor(\n    readonly projectId: string,\n    readonly emulators: DiscoveredEmulators,\n    readonly authToken: firebase.EmulatorMockTokenOptions | string | undefined\n  ) {}\n\n  cleanup() {\n    this.destroyed = true;\n    this.app?.delete();\n\n    this.app = undefined;\n  }\n\n  firestore(\n    settings?: firebase.firestore.Settings\n  ): firebase.firestore.Firestore {\n    assertEmulatorRunning(this.emulators, 'firestore');\n    const firestore = this.getApp().firestore();\n    if (settings) {\n      firestore.settings(settings);\n    }\n    firestore.useEmulator(\n      this.emulators.firestore.host,\n      this.emulators.firestore.port,\n      { mockUserToken: this.authToken }\n    );\n    return firestore;\n  }\n  database(databaseURL?: string): firebase.database.Database {\n    assertEmulatorRunning(this.emulators, 'database');\n    if (!databaseURL) {\n      const url = makeUrl(this.emulators.database, '');\n      // Make sure to set the namespace equal to projectId -- otherwise the RTDB SDK will by default\n      // use `${projectId}-default-rtdb`, which is treated as a different DB by the RTDB emulator\n      // (and thus WON'T apply any rules set for the `projectId` DB during initialization).\n      url.searchParams.append('ns', this.projectId);\n      databaseURL = url.toString();\n    }\n    const database = this.getApp().database(databaseURL);\n    database.useEmulator(\n      this.emulators.database.host,\n      this.emulators.database.port,\n      { mockUserToken: this.authToken }\n    );\n    return database;\n  }\n  storage(bucketUrl = `gs://${this.projectId}`): firebase.storage.Storage {\n    assertEmulatorRunning(this.emulators, 'storage');\n    const storage = this.getApp().storage(bucketUrl);\n    storage.useEmulator(\n      this.emulators.storage.host,\n      this.emulators.storage.port,\n      { mockUserToken: this.authToken }\n    );\n    return storage;\n  }\n\n  private getApp(): firebase.app.App {\n    if (this.envDestroyed) {\n      throw new Error(\n        'This RulesTestContext is no longer valid because its RulesTestEnvironment has been ' +\n          'cleaned up. (This may indicate a leak or missing `await` in your test cases.)'\n      );\n    }\n    if (this.destroyed) {\n      throw new Error(\n        'This RulesTestContext is no longer valid. When using withSecurityRulesDisabled, ' +\n          'make sure to perform all operations on the context within the callback function and ' +\n          'return a Promise that resolves when the operations are done.'\n      );\n    }\n    if (!this.app) {\n      this.app = firebase.initializeApp(\n        { projectId: this.projectId },\n        `_Firebase_RulesUnitTesting_${Date.now()}_${Math.random()}`\n      );\n    }\n    return this.app;\n  }\n}\n\nexport function assertEmulatorRunning<E extends keyof DiscoveredEmulators>(\n  emulators: DiscoveredEmulators,\n  emulator: E\n): asserts emulators is Record<E, HostAndPort> {\n  if (!emulators[emulator]) {\n    if (emulators.hub) {\n      throw new Error(\n        `The ${emulator} emulator is not running (according to Emulator hub). To force ` +\n          'connecting anyway, please specify its host and port in initializeTestEnvironment({...}).'\n      );\n    } else {\n      throw new Error(\n        `The host and port of the ${emulator} emulator must be specified. (You may wrap the test ` +\n          \"script with `firebase emulators:exec './your-test-script'` to enable automatic \" +\n          `discovery, or specify manually via initializeTestEnvironment({${emulator}: {host, port}}).`\n      );\n    }\n  }\n}\n","/**\n * @license\n * Copyright 2021 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { HostAndPort } from '../public_types';\nimport { makeUrl } from './url';\nimport fetch from 'node-fetch';\n\n/**\n * @private\n */\nexport async function loadDatabaseRules(\n  hostAndPort: HostAndPort,\n  databaseName: string,\n  rules: string\n): Promise<void> {\n  const url = makeUrl(hostAndPort, '/.settings/rules.json');\n  url.searchParams.append('ns', databaseName);\n  const resp = await fetch(url, {\n    method: 'PUT',\n    headers: { Authorization: 'Bearer owner' },\n    body: rules\n  });\n\n  if (!resp.ok) {\n    throw new Error(await resp.text());\n  }\n}\n\n/**\n * @private\n */\nexport async function loadFirestoreRules(\n  hostAndPort: HostAndPort,\n  projectId: string,\n  rules: string\n): Promise<void> {\n  const resp = await fetch(\n    makeUrl(hostAndPort, `/emulator/v1/projects/${projectId}:securityRules`),\n    {\n      method: 'PUT',\n      body: JSON.stringify({\n        rules: {\n          files: [{ content: rules }]\n        }\n      })\n    }\n  );\n\n  if (!resp.ok) {\n    throw new Error(await resp.text());\n  }\n}\n\n/**\n * @private\n */\nexport async function loadStorageRules(\n  hostAndPort: HostAndPort,\n  rules: string\n): Promise<void> {\n  const resp = await fetch(makeUrl(hostAndPort, '/internal/setRules'), {\n    method: 'PUT',\n    headers: {\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify({\n      rules: {\n        files: [{ name: 'storage.rules', content: rules }]\n      }\n    })\n  });\n  if (!resp.ok) {\n    throw new Error(await resp.text());\n  }\n}\n","/**\n * @license\n * Copyright 2021 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { RulesTestEnvironment, TestEnvironmentConfig } from './public_types';\nimport {\n  DiscoveredEmulators,\n  discoverEmulators,\n  getEmulatorHostAndPort\n} from './impl/discovery';\nimport {\n  assertEmulatorRunning,\n  RulesTestEnvironmentImpl\n} from './impl/test_environment';\nimport {\n  loadDatabaseRules,\n  loadFirestoreRules,\n  loadStorageRules\n} from './impl/rules';\n\n/**\n * Initializes a test environment for rules unit testing. Call this function first for test setup.\n *\n * Requires emulators to be running. This function tries to discover those emulators via environment\n * variables or through the Firebase Emulator hub if hosts and ports are unspecified. It is strongly\n * recommended to specify security rules for emulators used for testing. See minimal example below.\n *\n * @param config - the configuration for emulators. Most fields are optional if they can be discovered\n * @returns a promise that resolves with an environment ready for testing, or rejects on error.\n * @public\n * @example\n * ```javascript\n * const testEnv = await initializeTestEnvironment({\n *   firestore: {\n *     rules: fs.readFileSync(\"/path/to/firestore.rules\", \"utf8\"), // Load rules from file\n *     // host and port can be omitted if they can be discovered from the hub.\n *   },\n *   // ...\n * });\n * ```\n */\nexport async function initializeTestEnvironment(\n  config: TestEnvironmentConfig\n): Promise<RulesTestEnvironment> {\n  const projectId = config.projectId || process.env.GCLOUD_PROJECT;\n  if (!projectId) {\n    throw new Error(\n      'Missing projectId option or env var GCLOUD_PROJECT! Please specify the projectId either ' +\n        'way.\\n(A demo-* projectId is strongly recommended for unit tests, such as \"demo-test\".)'\n    );\n  }\n  const hub = getEmulatorHostAndPort('hub', config.hub);\n  let discovered = hub ? { ...(await discoverEmulators(hub)), hub } : undefined;\n\n  const emulators: DiscoveredEmulators = {};\n  if (hub) {\n    emulators.hub = hub;\n  }\n\n  for (const emulator of SUPPORTED_EMULATORS) {\n    const hostAndPort = getEmulatorHostAndPort(\n      emulator,\n      config[emulator],\n      discovered\n    );\n    if (hostAndPort) {\n      emulators[emulator] = hostAndPort;\n    }\n  }\n\n  if (config.database?.rules) {\n    assertEmulatorRunning(emulators, 'database');\n    await loadDatabaseRules(\n      emulators.database,\n      projectId,\n      config.database.rules\n    );\n  }\n  if (config.firestore?.rules) {\n    assertEmulatorRunning(emulators, 'firestore');\n    await loadFirestoreRules(\n      emulators.firestore,\n      projectId,\n      config.firestore.rules\n    );\n  }\n  if (config.storage?.rules) {\n    assertEmulatorRunning(emulators, 'storage');\n    await loadStorageRules(emulators.storage, config.storage.rules);\n  }\n\n  return new RulesTestEnvironmentImpl(projectId, emulators);\n}\n\nconst SUPPORTED_EMULATORS = ['database', 'firestore', 'storage'] as const;\n","/**\n * @license\n * Copyright 2021 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  EMULATOR_HOST_ENV_VARS,\n  getEmulatorHostAndPort\n} from './impl/discovery';\nimport { fixHostname, makeUrl } from './impl/url';\nimport { HostAndPort } from './public_types';\nimport fetch from 'node-fetch';\n\n/**\n * Run a setup function with background Cloud Functions triggers disabled. This can be used to\n * import data into the Realtime Database or Cloud Firestore emulator without triggering locally\n * emulated Cloud Functions.\n *\n * This method only works with Firebase CLI version 8.13.0 or higher. This overload works only if\n * the Emulator hub host:port is specified by the environment variable FIREBASE_EMULATOR_HUB.\n *\n * @param fn - a function which may be sync or async (returns a promise)\n * @public\n */\nexport async function withFunctionTriggersDisabled<TResult>(\n  fn: () => TResult | Promise<TResult>\n): Promise<TResult>;\n\n/**\n * Run a setup function with background Cloud Functions triggers disabled. This can be used to\n * import data into the Realtime Database or Cloud Firestore emulator without triggering locally\n * emulated Cloud Functions.\n *\n * This method only works with Firebase CLI version 8.13.0 or higher. The Emulator hub must be\n * running, which host and port are specified in this overload.\n *\n * @param fn - a function which may be sync or async (returns a promise)\n * @param hub - the host and port of the Emulator Hub (ex: `{host: 'localhost', port: 4400}`)\n * @public\n */\nexport async function withFunctionTriggersDisabled<TResult>(\n  hub: { host: string; port: number },\n  fn: () => TResult | Promise<TResult>\n): Promise<TResult>;\n\nexport async function withFunctionTriggersDisabled<TResult>(\n  fnOrHub: { host: string; port: number } | (() => TResult | Promise<TResult>),\n  maybeFn?: () => TResult | Promise<TResult>\n): Promise<TResult> {\n  let hub: HostAndPort | undefined;\n  if (typeof fnOrHub === 'function') {\n    maybeFn = fnOrHub;\n    hub = getEmulatorHostAndPort('hub');\n  } else {\n    hub = getEmulatorHostAndPort('hub', fnOrHub);\n    if (!maybeFn) {\n      throw new Error('The callback function must be specified!');\n    }\n  }\n  if (!hub) {\n    throw new Error(\n      'Please specify the Emulator Hub host and port via arguments or set the environment ' +\n        `varible ${EMULATOR_HOST_ENV_VARS.hub}!`\n    );\n  }\n\n  hub.host = fixHostname(hub.host);\n  makeUrl(hub, '/functions/disableBackgroundTriggers');\n  // Disable background triggers\n  const disableRes = await fetch(\n    makeUrl(hub, '/functions/disableBackgroundTriggers'),\n    {\n      method: 'PUT'\n    }\n  );\n  if (!disableRes.ok) {\n    throw new Error(\n      `HTTP Error ${disableRes.status} when disabling functions triggers, are you using firebase-tools 8.13.0 or higher?`\n    );\n  }\n\n  // Run the user's function\n  let result: TResult | undefined = undefined;\n  try {\n    result = await maybeFn();\n  } finally {\n    // Re-enable background triggers\n    const enableRes = await fetch(\n      makeUrl(hub, '/functions/enableBackgroundTriggers'),\n      {\n        method: 'PUT'\n      }\n    );\n\n    if (!enableRes.ok) {\n      throw new Error(\n        `HTTP Error ${enableRes.status} when enabling functions triggers, are you using firebase-tools 8.13.0 or higher?`\n      );\n    }\n  }\n\n  // Return the user's function result\n  return result;\n}\n\n/**\n * Assert the promise to be rejected with a \"permission denied\" error.\n *\n * Useful to assert a certain request to be denied by Security Rules. See example below.\n * This function recognizes permission-denied errors from Database, Firestore, and Storage JS SDKs.\n *\n * @param pr - the promise to be asserted\n * @returns a Promise that is fulfilled if pr is rejected with \"permission denied\". If pr is\n *          rejected with any other error or resolved, the returned promise rejects.\n * @public\n * @example\n * ```javascript\n * const unauthed = testEnv.unauthenticatedContext();\n * await assertFails(get(doc(unauthed.firestore(), '/private/doc'), { ... });\n * ```\n */\nexport function assertFails(pr: Promise<any>): Promise<any> {\n  return pr.then(\n    () => {\n      return Promise.reject(\n        new Error('Expected request to fail, but it succeeded.')\n      );\n    },\n    (err: any) => {\n      const errCode = err?.code?.toLowerCase() || '';\n      const errMessage = err?.message?.toLowerCase() || '';\n      const isPermissionDenied =\n        errCode === 'permission-denied' ||\n        errCode === 'permission_denied' ||\n        errMessage.indexOf('permission_denied') >= 0 ||\n        errMessage.indexOf('permission denied') >= 0 ||\n        // Storage permission errors contain message: (storage/unauthorized)\n        errMessage.indexOf('unauthorized') >= 0;\n\n      if (!isPermissionDenied) {\n        return Promise.reject(\n          new Error(\n            `Expected PERMISSION_DENIED but got unexpected error: ${err}`\n          )\n        );\n      }\n      return err;\n    }\n  );\n}\n\n/**\n * Assert the promise to be successful.\n *\n * This is a no-op function returning the passed promise as-is, but can be used for documentational\n * purposes in test code to emphasize that a certain request should succeed (e.g. allowed by rules).\n *\n * @public\n * @example\n * ```javascript\n * const alice = testEnv.authenticatedContext('alice');\n * await assertSucceeds(get(doc(alice.firestore(), '/doc/readable/by/alice'), { ... });\n * ```\n */\nexport function assertSucceeds<T>(pr: Promise<T>): Promise<T> {\n  return pr;\n}\n"],"names":["nodeFetch","fetch","firebase"],"mappings":"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"}